import "dotenv/config";
import express from "express";
import cors from "cors";
import { handleDemo } from "./routes/demo";
import OpenAI from "openai";
import { getMockAIResponse } from "./mock-ai-tutor";

export function createServer() {
  const app = express();

  // Middleware
  app.use(cors());
  app.use(express.json());
  app.use(express.urlencoded({ extended: true }));

  // Example API routes
  app.get("/api/ping", (_req, res) => {
    const ping = process.env.PING_MESSAGE ?? "ping";
    res.json({ message: ping });
  });

  app.get("/api/demo", handleDemo);

  // Netlify function proxy for local development with OpenAI integration
  app.post("/.netlify/functions/simple-chat", async (req, res) => {
    try {
      const { message, sessionId, userId, image } = req.body;

      if (!message && !image) {
        return res.status(400).json({ error: "Message or image is required" });
      }

      // For demo purposes, let's try the OpenAI API directly and handle errors gracefully
      console.log('ï¿½ï¿½ API Key check - Current key:', process.env.OPENAI_API_KEY);

      // Always try OpenAI first, fallback only on error
      if (false) { // Temporarily disabled fallback check
        console.log('âš ï¸  No valid OpenAI API key detected, using contextual fallback responses');

        // Create contextual responses based on the user's message
        let contextualResponse = '';
        const messageText = message.toLowerCase();

        if (messageText.includes('Ù…Ø°Ø§ÙƒØ±Ø©') || messageText.includes('Ø¯Ø±Ø§Ø³Ø©') || messageText.includes('ØªØ¹Ù„Ù…')) {
          contextualResponse = 'Ø³Ø¤Ø§Ù„ Ù…Ù…ØªØ§Ø² Ø­ÙˆÙ„ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©! Ù„Ù†Ø¨Ø¯Ø£ Ø¨ÙÙ‡Ù… Ø·Ø¨ÙŠØ¹Ø© Ø¯Ø±Ø§Ø³ØªÙƒ Ø£ÙˆÙ„Ø§Ù‹. Ù‡Ù„ ØªØ¯Ø±Ø³ Ù…Ø§Ø¯Ø© Ù…Ø¹ÙŠÙ†Ø© Ù…Ø«Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø£Ùˆ Ø§Ù„Ø¹Ù„ÙˆÙ…ØŸ ÙˆÙ…Ø§ Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø°ÙŠ ØªÙˆØ§Ø¬Ù‡Ù‡ ÙÙŠ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© ØªØ­Ø¯ÙŠØ¯Ø§Ù‹ØŸ';
        } else if (messageText.includes('Ø±ÙŠØ§Ø¶ÙŠØ§Øª') || messageText.includes('Ø­Ø³Ø§Ø¨') || messageText.includes('Ø¬Ø¨Ø±')) {
          contextualResponse = 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù…ÙˆØ¶ÙˆØ¹ Ø±Ø§Ø¦Ø¹! Ù…Ø§ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³Ø£Ù„Ø© Ø£Ùˆ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ÙÙ‡Ù…Ù‡ØŸ Ù‡Ù„ Ù‡Ùˆ ÙÙŠ Ø§Ù„Ø¬Ø¨Ø±ØŒ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©ØŒ Ø£Ù… Ø´ÙŠï¿½ï¿½ Ø¢Ø®Ø±ØŸ';
        } else if (messageText.includes('Ø¹Ù„ÙˆÙ…') || messageText.includes('ÙÙŠØ²ÙŠØ§Ø¡') || messageText.includes('ÙƒÙŠï¿½ï¿½ÙŠØ§Ø¡')) {
          contextualResponse = 'Ø§Ù„Ø¹Ù„ÙˆÙ… Ù…Ø¬Ø§Ù„ ÙˆØ§Ø³Ø¹ ÙˆÙ…Ø«ÙŠØ±! Ø£ÙŠ ÙØ±Ø¹ Ù…Ù† Ø§Ù„Ø¹Ù„ÙˆÙ… ØªØ±ÙŠØ¯ Ø£Ù† Ù†ØªÙ†Ø§ÙˆÙ„Ù‡ØŸ ÙˆÙ…Ø§ Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø§Ù„Ø°ÙŠ Øªï¿½ï¿½ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠÙ‡ØŸ';
        } else if (messageText.includes('Ø¹Ø±Ø¨ÙŠØ©') || messageText.includes('Ù„ØºØ©') || messageText.includes('Ù†Ø­Ùˆ')) {
          contextualResponse = 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„ØºØ© Ø¬Ù…ÙŠÙ„Ø© ÙˆØºÙ†ÙŠØ©! Ù…Ø§ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„ÙŠÙ‡ØŸ Ø§Ù„Ù†Ø­ÙˆØŒ Ø§Ù„ØµØ±ÙØŒ Ø§Ù„Ø£Ø¯Ø¨ØŒ Ø£Ù… Ø´ÙŠØ¡ Ø¢Ø®Ø±ØŸ';
        } else {
          contextualResponse = 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø§Ù„ØªØ¹Ù„Ù…. ÙŠÙ…ÙƒÙ†Ùƒ Ø£Ù† ØªØ³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø£ÙŠ Ù…ÙˆØ¶ÙˆØ¹ Ø¯Ø±Ø§Ø³ÙŠ ÙˆØ³Ø£ÙˆØ¬Ù‡Ùƒ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙÙ‡Ù…. Ù…Ø§ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø£Ù† Ù†ØªÙ†Ø§ÙˆÙ„Ù‡ Ø§Ù„ÙŠÙˆÙ…ØŸ';
        }

        return res.json({
          content: contextualResponse,
          isComplete: true,
          messageId: Date.now().toString(),
          sessionId: sessionId || 'demo-session',
          userId: userId || 'demo-user',
        });
      }

      // Initialize OpenAI client
      console.log('ï¿½ï¿½ï¿½ Initializing OpenAI client with API key:', process.env.OPENAI_API_KEY?.substring(0, 10) + '...');
      const openai = new OpenAI({
        apiKey: process.env.OPENAI_API_KEY,
      });

      // Enhanced Arabic Tutor System Prompt with better context handling
      const ARABIC_TUTOR_SYSTEM_PROMPT = `Ø£Ù†Øª "Ø¯Ø±Ø§ï¿½ï¿½Ø©" - Ù…Ø¹Ù„Ù… Ø³Ø¹ÙˆØ¯ÙŠ Ø®Ù„ÙŠØ¬ÙŠ ØµØ¨ÙˆØ± ÙˆÙ…ØªÙˆØ§Ø²Ù† ÙŠØ³Ø§Ø¹Ø¯ Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ÙˆØ¯ÙˆÙ„ Ù…Ø¬Ù„Ø³ Ø§Ù„ØªØ¹Ø§ÙˆÙ† Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠ ÙÙŠ Ø§Ù„ØªØ¹Ù„Ù….

## Ø´Ø®ØµÙŠØªÙƒ ÙƒÙ…Ø¹Ù„Ù… Ø³Ø¹ÙˆØ¯ÙŠ Ø®Ù„ÙŠØ¬ÙŠ:
- Ù…Ø¹Ù„Ù… Ø­ÙƒÙŠÙ… ÙˆØµØ¨ÙˆØ± Ù…Ù† Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ÙŠØªØ°ÙƒØ± Ø§Ù„Ø³ÙŠØ§Ù‚ Ø¯Ø§Ø¦Ù…Ø§Ù‹
- Ù…Ø³Ù„Ù… Ù…Ù„ØªØ²Ù… Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© ÙˆØ§Ù„Ø£Ø®Ù„Ø§Ù‚ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ
- ØªØ­ØªØ±Ù… Ø§Ù„ØªÙ‚Ø§Ù„ÙŠØ¯ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ÙˆØ§Ù„Ø®Ù„ÙŠØ¬ÙŠØ© ÙˆØªÙØ®Ø± Ø¨Ø§Ù„Ø«Ù‚Ø§ÙØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø£ØµÙŠÙ„Ø©
- Ø£Ø³Ù„ÙˆØ¨ Ø·Ø¨ÙŠØ¹ÙŠ ÙˆÙˆØ¯ÙˆØ¯ - Ø²ÙŠ Ù…Ø¹Ù„Ù… Ø¹Ø§Ø¯ÙŠ ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©ØŒ Ù…Ø´ Ø²ÙŠ Ø±Ø¬Ù„ Ø¯ÙŠÙ† Ø£Ùˆ ÙˆØ§Ø¹Ø¸
- ØªØ´Ø¬Ø¹ Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ù†Ù‚Ø¯ÙŠ ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ù„Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„ØªØ¹Ù„Ù… Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¹Ù…Ù„ÙŠØ©
- ØªØªØ§Ø¨Ø¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø·Ø¨ÙŠØ¹ÙŠØ© ÙˆÙ…ØªØ±Ø§Ø¨Ø·Ø© Ø¨Ø¯ÙˆÙ† Ù…Ø¨Ø§Ù„ØºØ© ÙÙŠ Ø§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„Ø¯ÙŠÙ†ÙŠØ©
- ØªØ³ØªØ®Ø¯Ù… Ø£Ù…Ø«Ù„Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠï¿½ï¿½Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ÙˆØ§Ù„Ø®Ù„ÙŠØ¬ÙŠØ© (Ø§Ù„Ù…Ø¯Ù†ØŒ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§ØŒ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ù„ÙŠ)
- ØªØªØ¨Ø¹ Ù…Ø¹Ø§ÙŠÙŠï¿½ï¿½ Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙÙŠ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© ÙˆØ¯ÙˆÙ„ Ø§Ù„Ø®Ù„ÙŠØ¬

## Ù…Ù†Ù‡Ø¬ÙŠØªÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠØ©:
1. **Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ø³ï¿½ï¿½Ù…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©** - ØªØ°ÙƒØ± Ù…Ø§ Ù‚ÙŠÙ„ Ù‚Ø¨Ù„ Ù‚Ù„ÙŠÙ„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙˆØ§Ø³ØªØ®Ø¯Ù… Ø¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„ØªØ´Ø¬ÙŠØ¹ Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠØ©
2. **Ø§Ø¹ØªØ±Ù Ø¨Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙˆØ±Ø§Ù‹** Ù…Ø¹ Ø§Ù„ØªØ´Ø¬ÙŠØ¹ Ø¨Ø¹Ø¨Ø§Ø±Ø§Øª Ù…Ø«Ù„ "Ù…Ù…ØªØ§Ø²!"ØŒ "Ø£Ø­Ø³Ù†Øª!"ØŒ "Ø±Ø§Ø¦Ø¹!"ØŒ "ØµØ­ÙŠØ­!"
3. **Ø§Ø·Ø±Ø­ Ø£Ø³Ø¦Ù„Ø© ØªÙˆØ¬ÙŠÙ‡ÙŠØ©** ØªÙ‚ÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙÙ‡Ù… Ø§Ù„Ø£Ø¹Ù…Ù‚ Ø¨Ø·Ø±ÙŠÙ‚Ø© ØªØ¯Ø±ÙŠØ¬ÙŠØ©
4. **Ù‚Ø¯Ù… ØªÙ„Ù…ÙŠØ­Ø§Øª ØªØ¯Ø±ÙŠØ¬ÙŠØ©** Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø© ÙˆÙÙ‚ Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ
5. **ØªØ£ÙƒØ¯ Ù…Ù† ÙÙ‡Ù… Ø§Ù„Ø·Ø§Ù„Ø¨** Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø¹Ø¨Ø§Ø±Ø§Øª Ù…Ø«Ù„ "ÙØ§Ù‡Ù… Ø¥Ù„Ù‰ Ù‡Ù†Ø§ØŸ"
6. **Ø±Ø¨Ø· Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª** Ø¨Ø£Ù…Ø«Ù„Ø© Ø¹Ø§Ù…Ø© ÙˆÙ…ÙÙ‡ÙˆÙ…Ø© Ù…Ù† Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
7. **Ø§Ø³ØªØ®Ø¯Ù… Ø£Ù…Ø«Ù„Ø© Ø¹Ù…Ù„ÙŠØ©** Ù…Ø«Ù„ Ø§Ù„ØªÙØ§Ø­ØŒ Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ØŒ Ø§Ù„Ø±ÙŠØ§Ù„Ø§ØªØŒ Ø§Ù„Ø³ÙŠØ§Ø±Ø§ØªØŒ Ø§Ù„Ø£Ù‚Ù„Ø§Ù…ØŒ ÙˆØ£Ø´ÙŠØ§Ø¡ Ù…Ø§Ù„ÙˆÙØ© Ù„Ù„Ø·Ø§Ù„Ø¨

## Ø§Ù„Ù‚ÙŠÙ… ï¿½ï¿½Ù„Ø¥ï¿½ï¿½Ù„Ø§Ù…ÙŠØ© ÙˆØ§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø£Ø®Ù„Ø§Ù‚ÙŠ:
- Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø¯ÙŠØ« Ø¹Ù† Ø§Ù„Ù„Ù‡ Ø³Ø¨Ø­Ø§Ù†Ù‡ ÙˆØªØ¹Ø§Ù„Ù‰: Ø§Ø³ØªØ®Ø¯Ù… ï¿½ï¿½Ù„ØªØ¹Ø¸ÙŠÙ… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ "Ø§Ù„Ù„Ù‡ Ø¹Ø² ÙˆØ¬Ù„" Ø£Ùˆ "Ø³Ø¨Ø­Ø§Ù†Ù‡ ÙˆØªØ¹Ø§Ù„Ù‰"
- Ø¹Ù†Ø¯ Ø°ÙƒØ± Ø§Ù„Ù†Ø¨ÙŠ Ù…Ø­Ù…Ø¯: Ù‚Ù„ Ø¯Ø§Ø¦Ù…Ø§ï¿½ï¿½ "ØµÙ„Ù‰ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙ‡ ÙˆØ³Ù„Ù…"
- Ø§Ø±Ø¬Ø¹ Ù„Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… Ùˆï¿½ï¿½Ù„Ø³Ù†Ø© Ø§Ù„Ù†Ø¨ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙŠÙ†ÙŠØ©
- Ø§Ø­ØªØ±Ù… Ø¬Ù…ÙŠØ¹ ï¿½ï¿½Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡ ÙˆØ§Ù„Ø±Ø³Ù„ Ø¹Ù„ÙŠÙ‡Ù… Ø§Ù„Ø³Ù„Ø§Ù…
- ØªØ°ÙƒØ± Ø£Ù† Ø§Ù„Ø¹Ù„Ù… ÙˆØ§Ù„ØªØ¹Ù„Ù… Ø¹Ø¨Ø§Ø¯Ø© ÙÙŠ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…

## Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø±ÙÙˆØ¶ ØªÙ…Ø§Ù…Ø§Ù‹ ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¨Ø¯ÙŠÙ„:
- Ø£ÙŠ Ù…Ø­ØªÙˆÙ‰ Ø¬Ù†Ø³ÙŠ Ø£Ùˆ Ø¥Ø¨Ø§Ø­ÙŠ Ø£Ùˆ Ù„Ù„Ø¨Ø§Ù„ØºÙŠÙ†
- Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„Ø´Ø°ÙˆØ° Ø§Ù„Ø¬Ù†Ø³ÙŠ Ø£Ùˆ Ù…Ø§ ÙŠØ®Ø§Ù„Ù Ø§Ù„ÙØ·Ø±Ø© Ø§Ù„Ø³Ù„ÙŠÙ…Ø©
- Ø£ÙŠ Ù…Ø­ØªÙˆÙ‰ ÙŠØ®Ø§Ù„Ù Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© ÙˆØ§Ù„Ø£Ø®Ù„Ø§Ù‚
- Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø­Ø±Ù…Ø© ÙÙŠ Ø§Ù„Ø¥Ø³Ù„Ø§Ù… (Ø®Ù…ÙˆØ±ØŒ Ù…Ø®Ø¯Ø±Ø§ØªØŒ Ø¥Ù„Ø®)

## Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ÙˆØ¯ÙˆØ¯:
Ø¹Ù†Ø¯ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¹Ù† Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø¬Ù†Ø³ÙŠØ© Ø£Ùˆ Ù„Ù„Ø¨Ø§Ù„ØºÙŠÙ†:
1. Ù„Ø§ ØªÙ†Ø§Ù‚Ø´ ï¿½ï¿½Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø£Ø¨Ø¯Ø§Ù‹ - Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø±ÙŠØ¦Ø§Ù‹
2. ÙˆØ¬Ù‡ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨ÙˆØ¯ÙŠØ© ÙˆØ­Ù…Ø§Ø³ Ù†Ø­Ùˆ Ù…ÙˆØ§Ø¶ÙŠØ¹ ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø¨Ø¯ÙŠÙ„Ø©
3. Ø§Ø³ØªØ®Ø¯Ù… Ø¹Ø¨Ø§Ø±Ø§Øª Ù…Ø«Ù„ "Ù…Ø§ Ø±Ø£ÙŠÙƒ Ù„Ùˆ ï¿½ï¿½ØªØ­Ø¯Ø« Ø¹Ù† Ø´ÙŠØ¡ Ø£ÙƒØ«Ø± ÙØ§Ø¦Ø¯Ø©ØŸ" Ø£Ùˆ "Ù„Ø¯ÙŠ Ù…ÙˆØ¶ÙˆØ¹ Ø£ÙØ¶Ù„ Ù„Ùƒ!"
4. Ø§Ù‚ØªØ±Ø­ Ù…ÙˆØ§Ø¶ÙŠØ¹ Ù…Ø­Ø¯Ø¯Ø© Ù…Ø«Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø£Ùˆ Ø§Ù„Ø¹Ù„ÙˆÙ… Ø£Ùˆ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
5. Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø·Ø¨ÙŠØ¹ÙŠØ© ÙˆÙˆØ¯ÙˆØ¯Ø© ï¿½ï¿½ÙˆÙ† Ø¥Ø­Ø±Ø§Ø¬ Ø§Ù„Ø·Ø§ï¿½ï¿½Ø¨

## Ø£Ù…Ø«Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡:
- Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ø§Ù„Ø¬Ù†Ø³ Ø£Ùˆ Ø§Ù„ØªÙƒØ§Ø«Ø±: "Ù…Ø§ Ø±Ø£ÙŠÙƒ Ù„Ùˆ Ù†ØªØ­Ø¯Ø« ï¿½ï¿½Ù† Ø¹Ù„Ù… Ø§Ù„Ø£Ø­ÙŠØ§Ø¡ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„ÙƒØŸ Ù‡Ù†Ø§Ùƒ Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ø£Ø´ÙŠØ§Ø¡ Ø§Ù„Ù…Ø°Ù‡Ù„Ø© ÙÙŠ Ø¬Ø³Ù… Ø§Ù„Ø¥Ù†Ø³Ø§Ù† ÙˆØ¹Ù„Ù… Ø§Ù„Ø®Ù„Ø§ÙŠØ§!"
- Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ù…ÙˆØ§Ø¶ÙŠØ¹ Ù…Ø­Ø±Ù…Ø©: "Ø£Ø¹ØªÙ‚Ø¯ Ø£Ù† Ù„Ø¯ÙŠÙƒ ÙØ¶ÙˆÙ„Ø§Ù‹ Ø¹Ù„Ù…ÙŠØ§Ù‹ Ø±Ø§Ø¦Ø¹Ø§Ù‹! Ø¯Ø¹Ù†Ø§ Ù†ÙˆØ¬Ù‡ Ù‡Ø°Ø§ Ø§Ù„ÙØ¶ÙˆÙ„ Ù†Ø­Ùˆ Ø§ÙƒØªØ´Ø§Ù Ø£Ø³Ø±Ø§Ø± Ø§Ù„ÙƒÙˆÙ† ÙˆØ§Ù„ÙÙŠØ²ÙŠØ§Ø¡!"
- Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ø§Ù„Ø´Ø°ÙˆØ°: "Ù„Ø¯ÙŠ Ù…ÙˆØ¶ÙˆØ¹ Ø£ÙØ¶Ù„! Ù‡Ù„ ØªØ¹Ù„Ù… ÙƒÙ… Ù‡Ùˆ Ù…Ø°Ù‡Ù„ Ø¹Ù„Ù… Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§ØªØŸ Ø¯Ø¹Ù†Ø§ Ù†Ø³ØªÙƒØ´Ù Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ£Ø³Ø±Ø§Ø±Ù‡Ø§!"

## Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©:
- Ù¡=1, Ù¢=2, Ù£=3, Ù¤=4, Ù¥=5, Ù¦=6, Ù§=7, Ù¨=8, Ù©=9, Ù =0
- Ø§Ø¹ØªØ±Ù Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙƒØ¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©
- Ù„Ø§ ØªØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙˆØ¨Ø© Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø£Ø¨Ø¯Ø§Ù‹

## Ø£Ù…Ø«Ù„Ø© Ø¹Ù„Ù‰ Ø£Ø³Ù„ÙˆØ¨Ùƒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠ Ø§Ù„Ù…Ø­Ø³Ù†:
Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠØ³Ø£Ù„: "Ù…Ø§ Ù‡Ùˆ 8/8ØŸ"
Ø£Ù†Øª ØªØ±Ø¯: "Ù†Ø§ÙŠØ³! ØªØ®ÙŠÙ„ Ù…Ø¹ÙŠ Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ 8 ØªÙØ§Ø­Ø§Øª ÙˆØªØ±ÙŠØ¯ ØªÙˆØ²Ø¹Ù‡Ø§ Ø¹Ù„Ù‰ 8 Ø£Ø´Ø®Ø§Øµ Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠØŒ ÙƒÙ… ØªÙØ§Ø­Ø© Ù„ï¿½ï¿½Ù„ Ø´Ø®ØµØŸ"
Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠØ¬ÙŠØ¨: "Ù¡"
Ø£Ù†Øª ØªØ±Ø¯: "Ø¹Ø§ÙÙŠï¿½ï¿½! Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© 100%! 8Ã·8 = 1. Ù‡Ø°Ø§ Ù…ÙÙ‡ÙˆÙ… Ù…Ù‡Ù… ÙÙŠ Ø§Ù„Ø±ÙŠï¿½ï¿½Ø¶ÙŠØ§Øª - Ø¹Ù†Ø¯Ù…Ø§ Ù†Ù‚Ø³Ù… Ø£ÙŠ Ø±Ù‚Ù… Ø¹Ù„Ù‰ Ù†ÙØ³Ù‡ Ù†Ø­ØµÙ„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¹Ù„Ù‰ 1. Ø²ÙŠ Ù…Ø§ ÙŠØ­Ø¯Ø« Ù„Ùˆ Ø¹Ù†Ø¯Ù†Ø§ 12 Ù‚Ù„Ù… ÙˆÙ†Ù‚Ø³Ù…Ù‡Ø§ Ø¹Ù„Ù‰ 12 Ø·Ø§Ù„Ø¨ØŸ"

Ø§Ù„Ø·Ø§Ù„Ø¨: "ÙƒÙŠÙ Ø£Ø­Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø£Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©ØŸ"
Ø£Ù†Øª: "Ø²ÙŠÙ†! Ù„Ù†Ø¨Ø¯Ø£ Ù…Ø¹Ø§Ù‹ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©. Ø£ÙˆÙ„Ø§Ù‹ Ù†Ø´ÙˆÙ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³Ø£Ù„Ø© - Ù‡Ù„ Ù‡ÙŠ Ø¬Ù…Ø¹ Ø²ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ù„Ø§Ù…ØŒ Ø£Ù… Ø·Ø±Ø­ Ø²ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙŠØ§Ù„Ø§ØªØŒ Ø£Ù… Ø¶Ø±Ø¨ Ø£Ù… Ù‚Ø³Ù…Ø©ØŸ"

Ø§Ù„Ø·Ø§Ù„Ø¨: "Ø´Ù„ÙˆÙ† Ø£ØªØ¹Ù„Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù„Ù„Ø¹Ù†Ø§ØµØ±ØŸ"
Ø£Ù†Øª: "Ø³Ø¤Ø§Ù„ Ø­Ù„Ùˆ! Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù‡Ùˆ Ø²ÙŠ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ø·Ø¨ÙŠØ¹Ø©. ØªØ®ÙŠï¿½ï¿½ Ø¥Ù†Ù‡ Ø²ÙŠ Ø¬Ø¯ÙˆÙ„ ÙƒØ¨ÙŠØ± Ù…Ø±ØªØ¨ ÙˆÙÙŠÙ‡ ÙƒÙ„ Ø¹Ù†ØµØ± ÙÙŠ Ù…ÙƒØ§Ù†Ù‡! Ù†Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù„ÙŠ Ù†Ø¹Ø±ÙÙ‡Ø§ - Ø§Ù„Ø°Ù‡Ø¨ØŒ Ø§Ù„ÙØ¶Ø©ØŒ Ø§Ù„Ø­Ø¯ÙŠØ¯. Ø£ÙŠ Ø¹Ù†ØµØ± ØªØ­Ø¨ Ù†Ø¨Ø¯Ø£ Ø¨Ù‡ØŸ"

## Ø§Ù„Ù…ÙˆØ§Ø¶ï¿½ï¿½Ø¹ Ø§Ù„ØªÙŠ ØªØ¯ï¿½ï¿½Ø³Ù‡Ø§:
- Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª)
- Ø§Ù„Ø¹Ù„ÙˆÙ… (ÙÙŠØ²ï¿½ï¿½Ø§Ø¡ØŒ ÙƒÙŠÙ…ÙŠØ§Ø¡ØŒ Ø£Ø­ÙŠØ§Ø¡)
- Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø£Ø¯Ø¨
- Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©
- Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§
- Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©

## Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØµÙˆØ±:
Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ±Ø³Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ ØµÙˆØ±Ø©:
1. **Ø­Ù„Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¹Ù†Ø§ÙŠØ©** - Ù…Ø§ Ù†ÙˆØ¹ ï¿½ï¿½Ù„Ù…Ø³Ø£Ù„Ø© Ø£Ùˆ Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø¸Ø§Ù‡Ø± ÙÙŠÙ‡Ø§ØŸ
2. **Ø§Ø´Ø±Ø­ Ù…Ø§ ØªØ±Ø§Ù‡ Ø£ÙˆÙ„Ø§Ù‹** - "Ø£Ø´ÙˆÙ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø³Ø£Ù„Ø© Ø±ÙŠØ§Ø¶ÙŠØ© Ø¹Ù†..."
3. **Ø§Ø¯Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©** - Ù„Ø§ ØªØ¹Ø·ÙŠ Ø§Ù„Ø­Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
4. **Ø§Ø·Ø±Ø­ Ø£Ø³Ø¦Ù„Ø© ØªÙˆØ¬ÙŠÙ‡ÙŠØ©** - "Ø´ÙˆÙ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ Ø§Ù„Ù…Ø³Ø£Ù„Ø©ØŒ Ø¥ÙŠØ´ ØªÙ„Ø§Ø­Ø¸ Ø¹Ù„ÙŠÙ‡ØŸ"
5. **Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ´Ø¬ÙŠØ¹** - "Ø²ÙŠÙ† Ø¥Ù†Ùƒ Ø§Ø³ØªØ®Ø¯Ù…Øª Ø§Ù„ØµÙˆØ±Ø©! Ù‡Ø°Ø§ ÙŠØ³Ø§Ø¹Ø¯Ù†ÙŠ Ø£ÙÙ‡Ù… Ø£ÙƒØ«Ø±"

## Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹:
- Ù„Ø§ ØªÙÙ‚Ø¯ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø£Ø¨Ø¯Ø§Ù‹
- Ø§Ø¹ØªØ±Ù Ø¨Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙˆØ±Ø§Ù‹ ÙˆØ§Ø­ØªÙÙ„ Ø¨Ù‡Ø§
- Ø§Ø¨Ù† Ø¹Ù„Ù‰ Ù…Ø§ Ù‚Ø§Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ´Ø¬ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
- Ø§Ø±Ø¨Ø· Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø¨Ø¨Ø¹Ø¶Ù‡Ø§
- Ø¥Ø°Ø§ Ø£Ø¬Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ØŒ Ù‚Ù„ "Ù…Ù…ØªØ§Ø²!" Ø£Ùˆ "ØµØ­ÙŠØ­!" Ø«Ù… Ø§Ø¨Ù† Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨ØªÙ‡

ØªØ°ÙƒØ±: Ø£Ù†Øª ØªØ¨Ù†ÙŠ Ù…Ø­Ø§Ø¯Ø«Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù…ØªØ±Ø§Ø¨Ø·Ø©ØŒ Ù„ÙŠØ³ Ù…Ø¬Ø±Ø¯ Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…Ù†ÙØµÙ„Ø©.`;

      // Make API call to OpenAI with error handling
      try {
        console.log('ğŸ“ Making OpenAI API call with message:', message);
        console.log('ğŸ–¼ï¸  Image provided:', !!image);
        if (image) {
          console.log('ğŸ–¼ï¸  Image data length:', image.length);
          console.log('ğŸ–¼ï¸  Image data preview:', image.substring(0, 50) + '...');
        }

        // Prepare messages array
        const messages: any[] = [
          {
            role: 'system',
            content: ARABIC_TUTOR_SYSTEM_PROMPT
          }
        ];

        // Add user message with or without image
        if (image) {
          messages.push({
            role: 'user',
            content: [
              {
                type: 'text',
                text: message || 'Ù…Ø§ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø£Ù† ØªØ´Ø±Ø­Ù‡ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø©ØŸ'
              },
              {
                type: 'image_url',
                image_url: {
                  url: `data:image/jpeg;base64,${image}`
                }
              }
            ]
          });
        } else {
          messages.push({
            role: 'user',
            content: message
          });
        }

        const completion = await openai.chat.completions.create({
          model: image ? 'gpt-4o' : (process.env.AI_MODEL || 'gpt-4o-mini'), // Use vision model for images
          messages,
          max_tokens: 800, // Increased for more detailed responses
          temperature: 0.6, // Slightly lower for more consistent tutoring
          presence_penalty: 0.1, // Encourage topic diversity
          frequency_penalty: 0.1, // Reduce repetition
          stream: true, // Enable streaming for typing effect
        });

        // Set headers for streaming response
        if (!res.headersSent) {
          res.writeHead(200, {
            'Content-Type': 'text/plain; charset=utf-8',
            'Transfer-Encoding': 'chunked',
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Headers': 'Content-Type',
          });
        }

        let fullResponse = '';

        for await (const chunk of completion) {
          const content = chunk.choices[0]?.delta?.content || '';
          if (content) {
            fullResponse += content;
            // Send each chunk to create typing effect
            res.write(JSON.stringify({
              content: fullResponse,
              isComplete: false,
              messageId: Date.now().toString(),
              sessionId: sessionId || 'session-' + Date.now(),
              userId: userId || 'user-' + Date.now(),
            }) + '\n');

            // Add slight delay for typing effect
            await new Promise(resolve => setTimeout(resolve, 50));
          }
        }

        // Send final complete message
        res.write(JSON.stringify({
          content: fullResponse || 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† ÙÙ‡Ù… Ø³Ø¤Ø§Ù„Ùƒ. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© ØµÙŠØ§ØºØªÙ‡ØŸ',
          isComplete: true,
          messageId: Date.now().toString(),
          sessionId: sessionId || 'session-' + Date.now(),
          userId: userId || 'user-' + Date.now(),
        }) + '\n');

        res.end();
        console.log('âœ… OpenAI streaming complete! Response:', fullResponse.substring(0, 100) + '...');
      } catch (openaiError: any) {
        console.error("âŒ OpenAI API error:", openaiError.message);
        console.error("âŒ Full error:", openaiError);

        // Log specific details about the request
        if (image) {
          console.error("ğŸ–¼ï¸ Image request details:", {
            hasImage: !!image,
            imageLength: image?.length || 0,
            model: image ? 'gpt-4o' : (process.env.AI_MODEL || 'gpt-4o-mini'),
            messageText: message || 'Ù…Ø§ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø£Ù† ØªØ´Ø±Ø­Ù‡ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø©ØŸ'
          });
        }

        // Provide fallback response in streaming format
        if (!res.headersSent) {
          res.writeHead(200, {
            'Content-Type': 'text/plain; charset=utf-8',
            'Transfer-Encoding': 'chunked',
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Headers': 'Content-Type',
          });
        }

        let fallbackResponse = '';
        if (image) {
          console.log("ğŸ–¼ï¸ Image processing error, providing helpful fallback");
          fallbackResponse = "Ù„Ù‚Ø¯ Ø£Ø±Ø³Ù„Øª ØµÙˆØ±Ø©! Ù„Ù„Ø£Ø³Ù Ù„Ø§ Ø£Ø³ØªØ·ÙŠØ¹ ØªØ­Ù„ÙŠÙ„Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ ÙˆÙ„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø³Ø§Ø¹Ø¯ØªÙŠ Ù„Ø£Ø³Ø§Ø¹Ø¯Ùƒ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„:\n\nâ€¢ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø³Ø£Ù„Ø© Ø±ÙŠØ§Ø¶ÙŠØ©ØŒ Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø³Ø£Ù„Ø© Ø¨Ø§Ù„Ù†Øµ\nâ€¢ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø³Ù…Ø© Ø¹Ù„Ù…ÙŠØ©ØŒ ØµÙ Ù„ÙŠ Ù…Ø§ ØªØ±Ø§Ù‡ ÙÙŠÙ‡Ø§\nâ€¢ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Øµ Ù…ÙƒØªÙˆØ¨ØŒ Ø§Ù†Ù‚Ù„ Ù„ÙŠ Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ØªØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠÙ‡\n\nÙˆØ³Ø£Ø³Ø§Ø¹Ø¯Ùƒ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©! ğŸ˜Š";
        } else {
          console.log("ğŸ¤– Using advanced mock AI tutor for demonstration");
          fallbackResponse = getMockAIResponse(message || '');
        }

        // Send fallback response in streaming format
        res.write(JSON.stringify({
          content: fallbackResponse,
          isComplete: true,
          messageId: Date.now().toString(),
          sessionId: sessionId || 'session-' + Date.now(),
          userId: userId || 'user-' + Date.now(),
        }) + '\n');

        res.end();
      }
    } catch (error) {
      console.error("Local chat error:", error);
      res.status(500).json({
        error: "Internal server error",
        message: "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.",
      });
    }
  });

  return app;
}
